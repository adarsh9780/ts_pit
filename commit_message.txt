feat(agent_v3): add direct-answer routing and SQL-first execution guardrails

Implements planner-driven no-tool responses for state-only questions and
strengthens execution safety/preference for backend data retrieval via SQL.

Changes:
- backend/agent_v3/state.py
  - add `plan_requires_execution: bool` to runtime state
- backend/agent_v3/planning.py
  - extend planner output model with `requires_execution`
  - add deterministic direct-state question detection (selected/current alert)
    and force `requires_execution=false` for those requests
  - when execution is not required, archive/skip unresolved pending steps to
    prevent stale tool execution on follow-up questions
  - tighten SQL-intent keyword detection to reduce false positives
  - include `plan_requires_execution` in planner state updates
- backend/agent_v3/prompts/planner.yaml
  - require planner to output `requires_execution`
  - document no-tool path when current context/prior outputs are sufficient
- backend/agent_v3/graph.py
  - master routes directly to `respond` when `plan_requires_execution=false`
  - responder now receives current alert context JSON
- backend/agent_v3/prompts/execution.yaml
  - add explicit policy: prefer execute_sql for backend retrieval, execute_python
    mainly for post-fetch analysis, avoid full-table reads, avoid SELECT *
- backend/agent_v3/execution.py
  - add deterministic tool bias:
    - force execute_sql first for retrieval-style steps
    - prefer execute_python for analysis-style steps only when prior data exists
- backend/agent_v3/tools.py
  - enforce bounded SQL results by auto-appending `LIMIT 200` when missing
  - return `query_auto_limited` metadata and executed bounded query

Validation:
- `python3 -m py_compile` passed for updated state/planning/graph/execution/tools
- `uv run python` prompt variable checks passed

---

fix(agent_v3 api): pass structured current_alert into graph input state

Fixes incorrect direct-answer behavior ("There is no alert currently selected")
when frontend clearly provides selected alert context.

Root cause:
- /agent/chat only injected alert context into enriched message text.
- agent_v3 runtime state expected `current_alert` in structured input schema.
- Missing structured field caused default/empty current_alert in graph nodes.

Changes:
- backend/api/routers/agent.py
  - when `agent_mode == "v3"` and `alert_context` exists, add
    `input_state["current_alert"]` with mapped fields:
    - alert_id, ticker, start_date, end_date, buy_qt, sell_qt
  - keep v1/v2 behavior untouched by guarding on agent_mode
  - safely coerce alert id to int when possible

Validation:
- `python3 -m py_compile backend/api/routers/agent.py` passed

---

fix(agent_v3): prevent planner/master no-op recursion loops

Fixes GraphRecursionError caused by planner returning `plan_action=reuse` with
no actionable pending steps, which repeatedly routed master->planner.

Changes:
- backend/agent_v3/planning.py
  - coerce `reuse` -> `append` when current state has no pending/running steps
  - add fallback synthetic step when append/replace returns empty step list
    to avoid no-op planning loops
- backend/agent_v3/graph.py
  - add master-side stop condition:
    if planner already ran for current question and state still has no steps,
    route to `respond` with terminal_error instead of replanning indefinitely

Validation:
- `python3 -m py_compile backend/agent_v3/planning.py backend/agent_v3/graph.py` passed
- `uv run python` graph import smoke check passed

---

feat(agent_v3 planner): expose tool capabilities + artifact knowledge with schema guardrail

Improves planner quality by giving it capability/context visibility while keeping
planner outputs intent-only, and adds a deterministic preflight injection for
SQL-like tasks when schema grounding is missing.

Changes:
- backend/agent_v3/planning.py
  - pass `tool_descriptions` and `artifact_knowledge` into planner prompt context
  - add SQL-intent detection on planned steps
  - add deterministic schema-grounding step injection:
    - prepends a step to read `artifacts/DB_SCHEMA_REFERENCE.yaml` when
      SQL/data-query intent exists and no schema step is present in existing/new steps
  - apply guardrail for both append and replace plan actions
- backend/agent_v3/prompts/planner.yaml
  - explicitly instruct planner to use tool capabilities for planning decisions
  - add artifact context (`artifacts/*`) and available tool list sections

Validation:
- `python3 -m py_compile backend/agent_v3/planning.py` passed
- `uv run python` planner prompt variables check passed

---

feat(agent_v3 execution): retry once on empty SQL result (no-data path)

Adds a controlled retry path when execute_sql succeeds but returns zero rows,
so the LLM gets one chance to adjust query arguments before finalizing.

Changes:
- backend/agent_v3/execution.py
  - add `_is_empty_sql_success` detection for successful SQL calls with 0 rows
  - add `_has_no_data_retry` guard to ensure this path retries only once
  - on first empty SQL result:
    - append retry_history entry with `error_code=NO_DATA`
    - set retry context (`last_error_code=NO_DATA`) and retry same step with execute_sql
  - keep existing max-attempt and error handling behavior unchanged
- backend/agent_v3/prompts/execution.yaml
  - add NO_DATA guidance: revise SQL to be less restrictive while preserving business intent and read-only SELECT safety

Validation:
- `python3 -m py_compile backend/agent_v3/execution.py` passed
- `uv run python` execution prompt variables check passed

---

fix(agent_v3 context): pass buy/sell quantities from frontend into current_alert state

Fixes current_alert quantity fields always being zero during agent reasoning.

Root cause:
- Frontend `alert_context` payload did not include quantity fields.
- Backend v3 input mapping hardcoded `buy_qt`/`sell_qt` to `0`.

Changes:
- frontend/src/features/agent/composables/useAgentChat.js
  - include `buy_qt` and `sell_qt` in `alert_context` payload
  - map from available alert detail keys with fallbacks:
    `buy_qt || buy_quantity || buyQty`, `sell_qt || sell_quantity || sellQty`
- backend/api/routers/agent.py
  - extend `AlertContext` model with optional quantity fields:
    `buy_qt`, `sell_qt`, `buy_quantity`, `sell_quantity`
  - map incoming values into v3 `current_alert` using safe numeric coercion
  - remove hardcoded zero defaults in v3 input mapping path

Validation:
- `python3 -m py_compile backend/api/routers/agent.py` passed
- verified buy/sell quantity fields are now present in frontend + backend mapping

---

feat(agent_v3 planner): add requires_execution_reason for plan transparency

Adds explicit planner rationale for execution vs direct-answer decisions.

Changes:
- backend/agent_v3/state.py
  - add `plan_requires_execution_reason` to AgentV3State
- backend/agent_v3/planning.py
  - extend `Plan` schema with `requires_execution_reason`
  - set deterministic reason for direct state-only fallback path
  - include execution reason in planner-visible plan text
  - persist reason back into state (`plan_requires_execution_reason`)
- backend/agent_v3/prompts/planner.yaml
  - update output contract to require `requires_execution_reason`

Validation:
- `python3 -m py_compile backend/agent_v3/state.py backend/agent_v3/planning.py` passed
- `uv run python` planner prompt variable check passed
